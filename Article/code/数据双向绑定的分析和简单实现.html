<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据双向绑定的分析和简单实现 | 源于生活</title>
    <meta name="description" content="write something！">
    
    
    <link rel="preload" href="/assets/css/0.styles.97ad5445.css" as="style"><link rel="preload" href="/assets/js/app.beb6e1a2.js" as="script"><link rel="preload" href="/assets/js/2.fb87c654.js" as="script"><link rel="preload" href="/assets/js/27.d1de37b1.js" as="script"><link rel="prefetch" href="/assets/js/10.76b112d8.js"><link rel="prefetch" href="/assets/js/11.aa7e37d8.js"><link rel="prefetch" href="/assets/js/12.16c26b7b.js"><link rel="prefetch" href="/assets/js/13.a5ff24d9.js"><link rel="prefetch" href="/assets/js/14.76e2d83a.js"><link rel="prefetch" href="/assets/js/15.7531a012.js"><link rel="prefetch" href="/assets/js/16.32b1eed6.js"><link rel="prefetch" href="/assets/js/17.98086da0.js"><link rel="prefetch" href="/assets/js/18.ce8a9952.js"><link rel="prefetch" href="/assets/js/19.1b9a8c39.js"><link rel="prefetch" href="/assets/js/20.216b83ff.js"><link rel="prefetch" href="/assets/js/21.caf31454.js"><link rel="prefetch" href="/assets/js/22.14b71624.js"><link rel="prefetch" href="/assets/js/23.8b830af2.js"><link rel="prefetch" href="/assets/js/24.38b52520.js"><link rel="prefetch" href="/assets/js/25.1b35fa6f.js"><link rel="prefetch" href="/assets/js/26.a60509d3.js"><link rel="prefetch" href="/assets/js/28.e8a55e3b.js"><link rel="prefetch" href="/assets/js/29.6d4afabc.js"><link rel="prefetch" href="/assets/js/3.6e21b941.js"><link rel="prefetch" href="/assets/js/30.7d58ead2.js"><link rel="prefetch" href="/assets/js/31.1506f023.js"><link rel="prefetch" href="/assets/js/4.c063c58b.js"><link rel="prefetch" href="/assets/js/5.e9ec8af5.js"><link rel="prefetch" href="/assets/js/6.1d843266.js"><link rel="prefetch" href="/assets/js/7.af3685bd.js"><link rel="prefetch" href="/assets/js/8.516f11f2.js"><link rel="prefetch" href="/assets/js/9.6b635f29.js">
    <link rel="stylesheet" href="/assets/css/0.styles.97ad5445.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">源于生活</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>关于code</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Article/code/地图学习.html" class="sidebar-link">地图学习笔记</a></li><li><a href="/Article/code/数据双向绑定的分析和简单实现.html" class="active sidebar-link">数据双向绑定的分析和简单实现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Article/code/多语言.html" class="sidebar-link">前端多语言方案</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue组件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>关于生活</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Article/life/选房.html" class="sidebar-link">待选名单</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="数据双向绑定的分析和简单实现"><a href="#数据双向绑定的分析和简单实现" aria-hidden="true" class="header-anchor">#</a> 数据双向绑定的分析和简单实现</h1> <div class="tip custom-block"><p>vue.js</p></div> <hr> <p>对于数据双向绑定，我们需要考虑的问题如下：</p> <ul><li>如何监听页面View的变化？</li> <li>如何将View的变化更新到Model？</li> <li>如何监听Model的变化？</li> <li>如何将Model的更新到View？
视图层的变化主要就是表单控件的用户输入行为造成的，比如input，select，textarea等。那么我们只需要监听一些事件，比如keypress，keydown，keyup，change。然后在事件回调函数中，将变化的值更新到Model中。当然同时，由于Model发生了变化，我们得再次更新一下View。</li></ul> <p>而Model的变化监听方式可以有多种，主要有以下几种： 发布订阅模式（Backbone），数据劫持（VueJS，AvalonJS），数据脏检查（Angularjs，RegularJS）
###发布订阅模式
发布订阅模式也称为观察者模式。直观地说，就是有一家报社和很多用户，报社就是发布者，用户就是订阅者。每当报社有新的报纸时，由于订阅者订阅了报纸，他们能第一时间收到新的报纸。当然订阅者也可以取消订阅。
<img src="https://pic4.zhimg.com/80/v2-9439fd8e580ae1302b6f50a45df633c0_hd.jpg" alt="此处输入图片的描述"></p> <p>我的理解，原生JS中的事件就是一种观察者模式。比如鼠标的点击事件，只要它点击了，以addEventListener方式订阅它的回调函数就会第一时间收到通知。除了现成的事件，JS的创建自定义事件看起来更直观。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code>    <span class="token keyword">var</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 订阅者订阅事件.</span>
    elem<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 发布事件.</span>
    elem<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在数据发生变化的时候，我们发布一个叫‘model-update’的事件。类似，当视图发生变化的时候，我们发布一个叫‘ui-update’的事件。那么，在这些事件发生时想要做什么动作只要让它去订阅这些事件即可。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>    <span class="token comment">// 更新数据 </span>
    <span class="token keyword">function</span> <span class="token function">updateData</span><span class="token punctuation">(</span><span class="token parameter">attr<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       data<span class="token punctuation">[</span>attr<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
       pubSub<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'model-update'</span><span class="token punctuation">,</span> attr<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 订阅ui-update事件 </span>
    pubSub<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'ui-update'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">attr<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token function">updateData</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 订阅model -update事件 </span>
    pubSub<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'model-update'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">attr<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token comment">//更新视图中所有单向绑定的值，用类似ng-bind的形式</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> attr <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">if</span><span class="token punctuation">(</span> bindingsMap<span class="token punctuation">[</span>attr<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
               bindingsMap<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                   item<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> data<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span><span class="token punctuation">)</span>
           <span class="token punctuation">}</span>
       <span class="token comment">//更新视图中所有双向绑定的值，用类似ng-model的形式</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>modelsMap<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
               modelsMap<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                   item<span class="token punctuation">.</span>value <span class="token operator">=</span> data<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span><span class="token punctuation">)</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//视图数据修改，发布ui-update事件   </span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keyup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">e</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">var</span> ele <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
       <span class="token keyword">var</span> attr <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'yc-model'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       pubSub<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'ui-update'</span><span class="token punctuation">,</span> attr<span class="token punctuation">,</span> ele<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>每次更新数据用updateData函数，这个函数执行了赋值操作之后会发布‘model-update’事件，这样就手动地解决了数据到视图这方向的更新问题了。</p> <p>###脏检查</p> <p>html部分：</p> <div class="language-html extra-class"><pre class="language-html"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ipt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>a<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>js部分：</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code>    <span class="token keyword">var</span> $scope <span class="token operator">=</span> <span class="token punctuation">{</span>
    	data<span class="token punctuation">:</span><span class="token string">''</span>
    <span class="token punctuation">}</span>
    a<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	a<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> $scope<span class="token punctuation">.</span>data
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">)</span>
    ipt<span class="token punctuation">.</span><span class="token function-variable function">oninput</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	 $scope<span class="token punctuation">.</span>data <span class="token operator">=</span> ipt<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
</code></pre></div><p>AngularJS的数据双向绑定是基于数据的脏检查机制的,考虑到性能问题,他当然不是定时去检查的。大体意思上来说，就是记录所有变量的当前值，当发生某些操作之后，通过$apply或者$digest进入脏检查环节。对比最近的一次值和现在的值是否一致，不一致则实现页面的更新，然后再执行一次直到数据不再发生变化。</p> <p>触发脏检查时全部遍历一次watch队列，实现视图的更新。</p> <p>那么，什么时候会触发脏检查呢？据说有以下几种情况。</p> <p>DOM事件，譬如用户输入文本，点击按钮(ng-click)等
XHR响应事件 ($http)
浏览器Location变更事件 ($location)
Timer事件($timeout, $interval)
执行$digest()或$apply()
最后一种情况应该是统一的入口，只不过前几种情况会自动调用这个入口而已。其他情况下，用户需要手动进入脏检查的话，就要执行了。</p> <h3 id="数据劫持"><a href="#数据劫持" aria-hidden="true" class="header-anchor">#</a> 数据劫持</h3> <p>最后是我们的主角,vue双向绑定的基本方法,数据劫持.
在此之前介绍如何用Object.defineProperty()实现双向数据绑定。
我们知道一个存储器属性有四个属性描述符：get，set，configurable，enumerable。
如何创建一个存储器属性：</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>    <span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
        name<span class="token punctuation">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">'nickname'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> value
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>当存在getter，setter函数时，属性的赋值操作会触发setter函数的执行，获取操作会触发getter函数的执行。按行业上的术语来说，这样的方法称之为数据劫持。举个栗子。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>    <span class="token keyword">function</span> <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">var</span> _value<span class="token punctuation">;</span>
           Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                 <span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">return</span> _value<span class="token punctuation">;</span>
                 <span class="token punctuation">}</span><span class="token punctuation">,</span>
                 <span class="token function-variable function">set</span><span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                     _value <span class="token operator">=</span> val<span class="token punctuation">;</span>
                     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'监听到数据发生了变化 '</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span><span class="token punctuation">)</span>
             obj<span class="token punctuation">[</span>attr<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">&quot;Claire_Yecao&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;监听到数据发生了变化&quot;</span>
    data<span class="token punctuation">.</span>name<span class="token punctuation">;</span> <span class="token comment">// get Claire_Yecao</span>
    
    <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'pp'</span><span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token comment">//pp</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
      <span class="token function-variable function">get</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">set</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token comment">//??</span>
    obj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token comment">//??</span>
</code></pre></div><p>有了以上的方法之后，我们不难知道，当数据（对象）发生变化，只要在setter函数中发布就好。结合发布订阅者模式，将手动更新数据的updateData函数变成赋值操作，对象会自动执行setter函数，然后就能发布‘model-update’事件了。</p> <p>想想还有复杂的问题，要是数据的类型是数组，而用push，shift等方法去操作数组，怎么办？</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div></div><pre class="language-js"><code> <span class="token comment">//将数据变成数组</span>
     data<span class="token punctuation">.</span>name <span class="token operator">=</span><span class="token punctuation">[</span> <span class="token string">'Claire_Yecao'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// &quot;监听到数据发生了变化&quot;</span>
     data<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'小小 '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 此时不会发生数据劫持 </span>
</code></pre></div><p>对于数组，我们针对数组的一些方法进行改写，使得它也能发生劫持。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>    <span class="token keyword">var</span> arrProto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
     <span class="token punctuation">[</span><span class="token string">'shift'</span><span class="token punctuation">,</span><span class="token string">'unshift'</span><span class="token punctuation">,</span><span class="token string">'push'</span><span class="token punctuation">,</span><span class="token string">'pop'</span><span class="token punctuation">,</span><span class="token string">'slice'</span><span class="token punctuation">,</span><span class="token string">'splice'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>arrProto<span class="token punctuation">,</span> method<span class="token punctuation">,</span><span class="token punctuation">{</span>
             <span class="token function-variable function">value</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                 <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'检测数据发生变化'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                 <span class="token keyword">return</span> result<span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
     <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     b<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrProto<span class="token punctuation">;</span>
    
     b<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 '检测数据发生变化'</span>
</code></pre></div><p>回到vue本身上来, 首先Vue会使用documentfragment劫持根元素里包含的所有节点，这些节点不仅包括标签元素，还包括文本，甚至换行的回车。</p> <p>然后Vue会把data中所有的数据，用defindProperty()变成Vue的访问器属性，这样每次修改这些数据的时候，就会触发相应属性的get，set方法。</p> <p>接下来编译处理劫持到的dom节点，遍历所有节点，根据nodeType来判断节点类型，根据节点本身的属性（是否有v-model等属性）或者文本节点的内容（是否符合的格式）来判断节点是否需要编译。对v-model，绑定事件当输入的时候，改变Vue中的数据。对文本节点，将他作为一个观察者watcher放入观察者列表，当Vue数据改变的时候，会有一个主题对象，对列表中的观察者们发布改变的消息，观察者们再更新自己，改变节点中的显示，从而达到双向绑定的目的。
</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Article/code/地图学习.html" class="prev">
          地图学习笔记
        </a></span> <span class="next"><a href="/Article/code/多语言.html">
          前端多语言方案
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.beb6e1a2.js" defer></script><script src="/assets/js/2.fb87c654.js" defer></script><script src="/assets/js/27.d1de37b1.js" defer></script>
  </body>
</html>
