<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue的mvvm原理 | 源于生活</title>
    <meta name="description" content="write something">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.2e629a8b.css" as="style"><link rel="preload" href="/assets/js/app.3f86075b.js" as="script"><link rel="preload" href="/assets/js/2.b61884c0.js" as="script"><link rel="preload" href="/assets/js/10.43843a91.js" as="script"><link rel="prefetch" href="/assets/js/11.6144a746.js"><link rel="prefetch" href="/assets/js/12.931ab5ee.js"><link rel="prefetch" href="/assets/js/13.200ba20e.js"><link rel="prefetch" href="/assets/js/14.78767d2c.js"><link rel="prefetch" href="/assets/js/15.8f783edc.js"><link rel="prefetch" href="/assets/js/16.9226847d.js"><link rel="prefetch" href="/assets/js/17.bf6644b0.js"><link rel="prefetch" href="/assets/js/18.14599e53.js"><link rel="prefetch" href="/assets/js/19.734e752a.js"><link rel="prefetch" href="/assets/js/20.3a5561e3.js"><link rel="prefetch" href="/assets/js/21.7064855e.js"><link rel="prefetch" href="/assets/js/22.f968cb6c.js"><link rel="prefetch" href="/assets/js/23.f03e443c.js"><link rel="prefetch" href="/assets/js/24.64ce1052.js"><link rel="prefetch" href="/assets/js/25.f684b2ad.js"><link rel="prefetch" href="/assets/js/26.545ca9e8.js"><link rel="prefetch" href="/assets/js/27.437372e3.js"><link rel="prefetch" href="/assets/js/28.3dbb8fe4.js"><link rel="prefetch" href="/assets/js/29.badca37d.js"><link rel="prefetch" href="/assets/js/3.606f011a.js"><link rel="prefetch" href="/assets/js/30.a93aa9de.js"><link rel="prefetch" href="/assets/js/31.1fba5591.js"><link rel="prefetch" href="/assets/js/32.bc8d95d4.js"><link rel="prefetch" href="/assets/js/33.46e8b848.js"><link rel="prefetch" href="/assets/js/34.259ea87a.js"><link rel="prefetch" href="/assets/js/35.6cb77e7b.js"><link rel="prefetch" href="/assets/js/36.dfa5f43c.js"><link rel="prefetch" href="/assets/js/37.ce07fe30.js"><link rel="prefetch" href="/assets/js/38.9aedea0c.js"><link rel="prefetch" href="/assets/js/39.12d20f3b.js"><link rel="prefetch" href="/assets/js/4.5960558f.js"><link rel="prefetch" href="/assets/js/40.0d7119e5.js"><link rel="prefetch" href="/assets/js/41.c463fcdd.js"><link rel="prefetch" href="/assets/js/42.75948f81.js"><link rel="prefetch" href="/assets/js/43.a64e9f06.js"><link rel="prefetch" href="/assets/js/44.9a36c39e.js"><link rel="prefetch" href="/assets/js/45.d55c6f21.js"><link rel="prefetch" href="/assets/js/5.722aa9ed.js"><link rel="prefetch" href="/assets/js/6.7cf19e7f.js"><link rel="prefetch" href="/assets/js/7.57aaa45a.js"><link rel="prefetch" href="/assets/js/8.9246eb47.js"><link rel="prefetch" href="/assets/js/9.b56c8b97.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2e629a8b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">源于生活</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>关于code</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Article/code/实现小型打包工具.html" class="sidebar-link">实现小型打包工具</a></li><li><a href="/Article/code/NextTick 原理分析.html" class="sidebar-link">NextTick 原理分析</a></li><li><a href="/Article/code/Service Worker.html" class="sidebar-link">Service Worker</a></li><li><a href="/Article/code/Vue 和 React 之间的区别.html" class="sidebar-link">Vue 和 React 之间的区别</a></li><li><a href="/Article/code/vue的mvvm原理.html" class="active sidebar-link">vue的mvvm原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Article/code/vue的mvvm原理.html#简述版" class="sidebar-link">简述版</a></li><li class="sidebar-sub-header"><a href="/Article/code/vue的mvvm原理.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/Article/code/前端路由原理.html" class="sidebar-link">前端路由原理</a></li><li><a href="/Article/code/vue编译过程.html" class="sidebar-link">vue编译过程</a></li><li><a href="/Article/code/浏览器的缓存策略.html" class="sidebar-link">浏览器的缓存策略</a></li><li><a href="/Article/code/浏览器缓存位置.html" class="sidebar-link">浏览器缓存位置</a></li><li><a href="/Article/code/多语言.html" class="sidebar-link">前端多语言方案</a></li><li><a href="/Article/code/地图学习.html" class="sidebar-link">地图学习笔记</a></li><li><a href="/Article/code/数据双向绑定的分析和简单实现.html" class="sidebar-link">数据双向绑定的分析和简单实现</a></li><li><a href="/Article/code/多语言.html" class="sidebar-link">前端多语言方案</a></li><li><a href="/Article/code/出租车平台性能优化.html" class="sidebar-link">出租车平台性能优化</a></li><li><a href="/Article/code/通过队列和栈实现深度优先遍历和广度优先遍历.html" class="sidebar-link">通过队列和栈实现深度优先遍历和广度优先遍历</a></li><li><a href="/Article/code/DSN解析.html" class="sidebar-link">DSN解析</a></li><li><a href="/Article/code/Web单张大图浏览缓慢问题解决.html" class="sidebar-link">Web单张大图浏览缓慢问题解决</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue组件</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue的mvvm原理"><a href="#vue的mvvm原理" class="header-anchor">#</a> vue的mvvm原理</h1> <h2 id="简述版"><a href="#简述版" class="header-anchor">#</a> 简述版</h2> <p>vue是采用数据劫持配合发布者-订阅者模式，通过object.defineProperty来劫持各个属性的set和get，在数据变动时，发布信息给依赖收集器，去通知观察者，做出对应的回调函数，区更新视图。
Mvvm作为绑定的入口，整合observe，compile和watcher三者，通过observe来监听model的数据变化，通过compile来解析编译模板指令，最终利用watcher搭起observe和compile的桥梁，做到双向绑定。</p> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <p>Vue 内部使用了 Object.defineProperty() 来实现数据响应式，通过这个函数可以监听到 set 和 get 的事件。</p> <div class="language- extra-class"><pre><code>function observe(obj) {
  // 判断类型
  if (!obj || typeof obj !== 'object') {
    return
  }
  Object.keys(obj).forEach(key =&gt; {
    defineReactive(obj, key, obj[key])
  })
}

function defineReactive(obj, key, val) {
  // 递归子属性
  observe(val)
  let dp = new Dep()
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter() {
      console.log('get value')
      // 将 Watcher 添加到订阅
      if (Dep.target) {
        dp.addSub(Dep.target)
      }
      return val
    },
    set: function reactiveSetter(newVal) {
      console.log('change value')
      val = newVal
      // 执行 watcher 的 update 方法
      dp.notify()
    }
  })
</code></pre></div><p>依赖收集，才能在属性更新的时候派发更新，所以接下来我们需要先触发依赖收集。Dep一个属性只有一个，用来存放watcher</p> <div class="language- extra-class"><pre><code>// 通过 Dep 解耦属性的依赖和更新操作
class Dep {
  constructor() {
    this.subs = []
  }
  // 添加依赖
  addSub(sub) {
    this.subs.push(sub)
  }
  // 更新
  notify() {
    this.subs.forEach(sub =&gt; {
      sub.update()
    })
  }
}
// 全局属性，通过该属性配置 Watcher
Dep.target = null
</code></pre></div><p>当需要依赖收集的时候调用 addSub，当需要派发更新的时候调用 notify。
vue在组件挂载时，会先对所有需要的属性调用 Object.defineProperty()，然后实例化 Watcher，传入组件更新的回调。在实例化过程中，会对模板中的属性进行求值，触发依赖收集。</p> <div class="language- extra-class"><pre><code>class Watcher {
  constructor(obj, key, cb) {
    // 将 Dep.target 指向自己
    // 然后触发属性的 getter 添加监听
    // 最后将 Dep.target 置空
    Dep.target = this
    this.cb = cb
    this.obj = obj
    this.key = key
    this.value = obj[key]
    Dep.target = null
  }
  update() {
    // 获得新值
    this.value = this.obj[this.key]
    // 调用 update 方法更新 Dom
    this.cb(this.value)
  }
}
</code></pre></div><p>以上就是 Watcher 的简单实现，在执行构造函数的时候将 Dep.target 指向自身，从而使得收集到了对应的 Watcher，在派发更新的时候取出对应的 Watcher 然后执行 update 函数。
测试</p> <div class="language- extra-class"><pre><code>var data = { name: 'yck' }
observe(data)
function update(value) {
  document.querySelector('div').innerText = value
}
// 模拟解析到 `` 触发的操作
new Watcher(data, 'name', update)
// update Dom innerText
data.name = 'yyy' </code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Article/code/Vue 和 React 之间的区别.html" class="prev">
        Vue 和 React 之间的区别
      </a></span> <span class="next"><a href="/Article/code/前端路由原理.html">
        前端路由原理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div class="cat-container" data-v-a13867c0><canvas id="vuepress-cat" width="280" height="250" class="live2d" data-v-a13867c0></canvas></div></div></div>
    <script src="/assets/js/app.3f86075b.js" defer></script><script src="/assets/js/2.b61884c0.js" defer></script><script src="/assets/js/10.43843a91.js" defer></script>
  </body>
</html>
